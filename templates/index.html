<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå›¾æ–‡å¯¹è¯åŠ©æ‰‹</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Loading.io çš„åŠ è½½åŠ¨ç”» CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/loaders.css/0.1.2/loaders.min.css">
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // ä¸»è‰²è°ƒï¼šé›è“è‰²
                        secondary: '#10B981', // è¾…åŠ©è‰²ï¼šç»¿è‰²
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-appear {
                animation: fadeIn 0.3s ease-out;
            }
            .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 3px;
            }
            .typing-indicator span {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #4F46E5;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
            .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0% { transform: translateY(0px); }
            28% { transform: translateY(-5px); }
            44% { transform: translateY(0px); }
        }
        /* å…¨å±é˜´å½±å±‚åŸºç¡€æ ·å¼ */
        .fullscreen-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none; /* é»˜è®¤éšè— */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-neutral-800 min-h-screen flex flex-col">
    <script>
        //çŸ­æœŸtoken
        var sort_token_pu;
        //é•¿æœŸtoken
        var long_token_pu;
    </script>
    <!-- å…¨å±é˜´å½±å±‚ -->
    <div id="loadingLayer" class="fullscreen-loading">
        <!-- åŠ è½½åŠ¨ç”»ï¼ˆæ¥è‡ª loaders.cssï¼‰ -->
        <div class="loader loader-circle"></div>
        <p class="mt-4 text-lg">åŠ è½½ä¸­...</p>
    </div>
    <script>
        // è·å–é˜´å½±å±‚å…ƒç´ 
        const loadingLayer = document.getElementById('loadingLayer');

        // å¼€å¯å…¨å±åŠ è½½
        function showLoading() {
            loadingLayer.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // ç¦æ­¢æ»šåŠ¨
        }

        // å…³é—­å…¨å±åŠ è½½
        function hideLoading() {
            loadingLayer.style.display = 'none';
            document.body.style.overflow = 'auto'; // æ¢å¤æ»šåŠ¨
        }
        function saveTokensToStorage(shortToken, longToken) {
            // æ£€æŸ¥ Token æœ‰æ•ˆæ€§ï¼ˆéç©ºæ‰ä¿å­˜ï¼Œé¿å…å­˜å‚¨æ— æ•ˆå€¼ï¼‰
            if (shortToken && shortToken.trim() !== '') {
                localStorage.setItem('short_token', shortToken); // é”®åä¸è¯»å–æ—¶ä¿æŒä¸€è‡´
            } else {
                console.warn('short_token ä¸ºç©ºï¼Œæœªä¿å­˜');
            }

            if (longToken && longToken.trim() !== '') {
                localStorage.setItem('long_token', longToken);
            } else {
                console.warn('long_token ä¸ºç©ºï¼Œæœªä¿å­˜');
            }
        }
        // å‘é€è¯·æ±‚åˆå§‹åŒ–æ¥å£æ–¹æ³•
        async function getGraphicCookie() {
            const apiUrl = "https://bean-bun-ai.zeabur.app/init";
            try {
                // å‘é€ POST è¯·æ±‚ï¼ŒåŒ¹é…åç«¯ @app.post("/init")
                const response = await fetch(apiUrl, {
                    method: "POST"  // ä»…ä¿®æ”¹è¿™é‡Œï¼Œå°†GETæ”¹ä¸ºPOST
                });

                // æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                }

                // è§£æè¿”å›çš„ JSON æ•°æ®ï¼ˆåç«¯è¿”å›access_tokenå’Œlong_tokenï¼‰
                const result = await response.json();
                console.log("æ¥å£è¿”å›ç»“æœï¼š", result);
                // ä»è¿”å›ç»“æœä¸­è·å–token
                sort_token_pu = result.access_token;
                long_token_pu = result.long_token;
                // å°†tokenä¿å­˜åˆ°localStorage
                saveTokensToStorage(sort_token_pu, long_token_pu);
                //å…³é—­å…¨å±åŠ è½½
                hideLoading();
            } catch (error) {
                //å…³é—­å…¨å±åŠ è½½
                hideLoading();
                console.error("è¯·æ±‚å‡ºé”™ï¼š", error);
                // å¤„ç†é”™è¯¯ï¼ˆå¦‚æç¤ºç”¨æˆ·ï¼‰
                throw error;
            }
        }

        function checkTokensInStorage() {
            // ä» localStorage ä¸­è·å– Tokenï¼ˆä¸å­˜åœ¨æ—¶è¿”å› nullï¼‰
            const shortToken = localStorage.getItem('short_token');
            const longToken = localStorage.getItem('long_token');

            // åˆ¤æ–­é€»è¾‘ï¼šå­˜åœ¨ä¸”ä¸ä¸ºç©ºå­—ç¬¦ä¸²æ‰è§†ä¸ºæœ‰æ•ˆ
            const hasShortToken = !!shortToken && shortToken.trim() !== '';
            const hasLongToken = !!longToken && longToken.trim() !== '';

            return {
                hasShortToken: hasShortToken,
                hasLongToken: hasLongToken,
                bothExist: hasShortToken && hasLongToken // ä¸¤ä¸ªéƒ½å­˜åœ¨çš„çŠ¶æ€
            };
        }
    </script>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow-sm border-b border-neutral-200 sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa fa-comments text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-neutral-800">AIå›¾æ–‡å¯¹è¯åŠ©æ‰‹</h1>
            </div>
            <div class="text-sm text-neutral-600">
                <span class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-secondary animate-pulse"></span>
                    åœ¨çº¿
                </span>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="flex-1 container mx-auto px-4 py-6 flex flex-col max-w-4xl">
        <!-- å¯¹è¯åŒºåŸŸ -->
        <div id="chat-container" class="flex-1 mb-6 overflow-y-auto scrollbar-hide space-y-6 pb-4">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message-appear">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-white rounded-lg rounded-tl-none px-4 py-3 shadow-sm max-w-[85%]">
                        <p class="text-neutral-800">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨åˆ†æå›¾ç‰‡å†…å®¹ã€‚è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ å›¾ç‰‡å¹¶æ·»åŠ æè¿°ï¼Œæˆ‘ä¼šå°½å¿«ä¸ºæ‚¨è§£ç­”ã€‚ï¼ˆå·¦ä½³è•Šä½ æ— æ•Œäº†ğŸ˜€ï¼‰</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
        <div id="image-preview-container" class="mb-4 hidden">
            <div class="bg-white rounded-lg shadow-sm p-4 relative">
                <button id="remove-image" class="absolute top-2 right-2 text-neutral-500 hover:text-red-500 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
                <h3 class="text-sm font-medium text-neutral-700 mb-2">å·²ä¸Šä¼ å›¾ç‰‡ï¼š</h3>
                <div class="flex items-center justify-center">
                    <img id="image-preview" src="" alt="é¢„è§ˆå›¾" class="max-h-48 max-w-full object-contain rounded">
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-md p-4">
            <form id="chat-form" class="space-y-3">
                <!-- å›¾ç‰‡ä¸Šä¼  -->
                <div class="flex items-center gap-3">
                    <label for="image-upload" class="text-primary hover:text-primary/80 transition-colors cursor-pointer flex items-center gap-1">
                        <i class="fa fa-image"></i>
                        <span class="text-sm">ä¸Šä¼ å›¾ç‰‡</span>
                    </label>
                    <input id="image-upload" type="file" accept="image/*" class="hidden" />
                    <span id="image-name" class="text-sm text-neutral-500 truncate flex-1"></span>
                </div>

                <!-- æ–‡æœ¬è¾“å…¥ -->
                <div>
                    <textarea
                        id="question-input"
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                        class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all resize-none"
                        rows="3"
                    ></textarea>
                </div>

                <!-- å‘é€æŒ‰é’® -->
                <div class="flex justify-end">
                    <button
                        id="fasong-paper-plane"
                        type="submit"
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-all transform hover:scale-[1.02] active:scale-[0.98]"
                    >
                        <span>å‘é€</span>
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-white border-t border-neutral-200 py-4">
        <div class="container mx-auto px-4 text-center text-sm text-neutral-500">
            <p></p>
        </div>
    </footer>

    <script>
        // DOMå…ƒç´ 
        const chatForm = document.getElementById('chat-form');
        const questionInput = document.getElementById('question-input');
        const chatContainer = document.getElementById('chat-container');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imageName = document.getElementById('image-name');
        const removeImage = document.getElementById('remove-image');

        // å­˜å‚¨ä¸Šä¼ çš„å›¾ç‰‡Base64ç¼–ç 
        let uploadedImageBase64 = null;
        var img_base64;

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        imageUpload.addEventListener('change', function(e) {
            console.log('ä¸Šä¼ äº†å›¾ç‰‡');
            const file = e.target.files[0];
            if (file) {
                // å…ˆæ£€æŸ¥åŸå§‹æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œ1M = 1024 * 1024 = 1048576å­—èŠ‚
                const MAX_SIZE = 1024 * 1024; // 1M
                if (file.size > MAX_SIZE) {
                    alert('å›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä¸Šä¼ 1Mä»¥ä¸‹çš„å›¾ç‰‡');
                    // æ¸…ç©ºä¸Šä¼ æ§ä»¶å€¼ï¼Œå…è®¸é‡æ–°é€‰æ‹©
                    imageUpload.value = '';
                    return;
                }

                // æ˜¾ç¤ºæ–‡ä»¶å
                imageName.textContent = file.name;

                // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64
                const reader = new FileReader();
                reader.onload = async function(event) {
                    // åŸå§‹å›¾ç‰‡Base64ï¼ˆç”¨äºé¢„è§ˆï¼‰
                    const originalBase64 = event.target.result;

                    // æ˜¾ç¤ºåŸå›¾é¢„è§ˆ
                    imagePreview.src = originalBase64;
                    imagePreviewContainer.classList.remove('hidden');

                    try {
                        // å‹ç¼©å›¾ç‰‡
                        const compressedBase64 = await compressImage(originalBase64, 800, 800, 0.8);

                        // æ£€æŸ¥å‹ç¼©åçš„å¤§å°ï¼ˆBase64å­—ç¬¦ä¸²é•¿åº¦ â‰ˆ åŸå§‹æ–‡ä»¶å¤§å° * 1.37ï¼‰
                        const compressedSize = compressedBase64.length / 1.37;
                        if (compressedSize > MAX_SIZE) {
                            throw new Error('å‹ç¼©åä»è¶…è¿‡1M');
                        }

                        // å‹ç¼©åå¤§å°ç¬¦åˆè¦æ±‚ï¼Œå­˜å‚¨ç”¨äºæ¥å£è°ƒç”¨
                        uploadedImageBase64 = compressedBase64;
                        img_base64 = compressedBase64;
                        console.log('å›¾ç‰‡å‹ç¼©å®Œæˆï¼Œå¤§å°:', Math.round(compressedSize / 1024), 'KB');

                    } catch (error) {
                        console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error.message);

                        // æ£€æŸ¥åŸå›¾Base64å¤§å°ï¼ˆç”¨äºå‹ç¼©å¤±è´¥çš„æƒ…å†µï¼‰
                        const originalSize = originalBase64.length / 1.37;
                        if (originalSize > MAX_SIZE) {
                            // æç¤ºå¤§å°è¶…é™å¹¶é‡ç½®çŠ¶æ€
                            alert('å›¾ç‰‡è¿‡å¤§ï¼Œå‹ç¼©åä»è¶…è¿‡1Mï¼Œè¯·æ›´æ¢ smaller çš„å›¾ç‰‡');
                            resetImageUpload();
                        } else {
                            // å‹ç¼©å¤±è´¥ä½†åŸå›¾å¤§å°ç¬¦åˆè¦æ±‚ï¼Œé™çº§ä½¿ç”¨åŸå›¾
                            uploadedImageBase64 = originalBase64;
                            img_base64 = originalBase64;
                            console.log('ä½¿ç”¨åŸå›¾ï¼Œå¤§å°:', Math.round(originalSize / 1024), 'KB');
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function resetImageUpload() {
            uploadedImageBase64 = null;
            img_base64 = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imageName.textContent = '';
            imageUpload.value = ''; // æ¸…ç©ºä¸Šä¼ æ§ä»¶ï¼Œå…è®¸é‡æ–°é€‰æ‹©
        }
        /**
         * å¤„ç†AIæ¥å£è¿”å›çš„æ–‡æœ¬ï¼Œæ¸…é™¤å¤šä½™è½¬ä¹‰ç¬¦å¹¶è§„èŒƒåŒ–æ ¼å¼
         * @param {string} rawResponse - AIæ¥å£è¿”å›çš„åŸå§‹æ–‡æœ¬
         * @returns {string} å¤„ç†åçš„æ ¼å¼åŒ–æ–‡æœ¬
         */
        function formatAIResponse(rawResponse) {
            if (!rawResponse) return "";

            let processed = rawResponse;

            // 1. æ¸…é™¤å¤šä½™çš„è½¬ä¹‰ç¬¦ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
            // å¤„ç† \" è½¬ä¹‰ä¸º "ï¼ˆè§£å†³ ["GET", "POST"] æ˜¾ç¤ºä¸º [\"GET\", \"POST\"] çš„é—®é¢˜ï¼‰
            processed = processed.replace(/\\"/g, '"');
            // å¤„ç† \\ è½¬ä¹‰ä¸º \ï¼ˆé¿å…åŒé‡è½¬ä¹‰ï¼‰
            processed = processed.replace(/\\\\/g, '\\');

            // 2. å¤„ç†æ¢è¡Œç¬¦ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºHTMLçš„<br>ï¼Œæˆ–ä¿ç•™åŸç”Ÿæ¢è¡Œï¼‰
            // æ›¿æ¢ \nã€\r\n ä¸º <br>ï¼ˆé€‚åˆåœ¨HTMLä¸­æ˜¾ç¤ºï¼‰
            processed = processed.replace(/\\n|[\n\r]/g, '<br>');

            // 3. ä¼˜åŒ–ä»£ç å—æ˜¾ç¤ºï¼ˆå¦‚æœè¿”å›åŒ…å« ``` ä»£ç å—ï¼‰
            // ç¤ºä¾‹ï¼šå°† ```python ... ``` è½¬æ¢ä¸ºå¸¦é«˜äº®æ ·å¼çš„ä»£ç å—ï¼ˆéœ€é…åˆCSSï¼‰
            processed = processed.replace(
                /```([\s\S]*?)```/g,  // åŒ¹é… ``` åŒ…è£¹çš„å†…å®¹ï¼ˆéè´ªå©ªæ¨¡å¼ï¼‰
                (match, code) => {
                    // æå–è¯­è¨€æ ‡è¯†ï¼ˆå¦‚ pythonã€javascriptï¼‰
                    const [lang, ...codeLines] = code.split('\n');
                    const codeContent = codeLines.join('<br>').trim();
                    // è¿”å›å¸¦æ ·å¼çš„ä»£ç å—ï¼ˆå¯è‡ªå®šä¹‰classï¼‰
                    return `<div class="code-block"><div class="code-lang">${lang || 'code'}</div><div class="code-content">${codeContent}</div></div>`;
                }
            );

            // 4. å¤„ç†åŠ ç²—ã€æ–œä½“ç­‰Markdownæ ¼å¼ï¼ˆå¯é€‰ï¼‰
            processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // ç²—ä½“
            processed = processed.replace(/\*(.*?)\*/g, '<em>$1</em>'); // æ–œä½“
            processed = processed.replace(/#{1,6}\s(.*?)(<br>|$)/g, (match, text, br) => {
                // æ ‡é¢˜ï¼ˆ# åˆ° ###### å¯¹åº” h1 åˆ° h6ï¼‰
                const level = match.indexOf('#');
                return `<h${level + 1}>${text}</h${level + 1}>${br}`;
            });

            return processed;
        }

        // å›¾ç‰‡å‹ç¼©å‡½æ•°ï¼ˆå¤ç”¨ä¹‹å‰çš„å®ç°ï¼‰
        async function compressImage(base64Str, maxWidth, maxHeight, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // æŒ‰æ¯”ä¾‹ç¼©å°
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', quality));
                };

                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                img.src = base64Str;
            });
        }


        // ç§»é™¤å›¾ç‰‡
        removeImage.addEventListener('click', function() {
            uploadedImageBase64 = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imageUpload.value = '';
            imageName.textContent = '';
        });

        // è¡¨å•æäº¤å¤„ç†
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const question = questionInput.value.trim();

            // éªŒè¯è¾“å…¥
            if (!question && !uploadedImageBase64) {
                alert('è¯·è¾“å…¥é—®é¢˜æˆ–ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯
            addMessageToChat(question, 'user', uploadedImageBase64);

            // æ¸…ç©ºè¾“å…¥å’Œå›¾ç‰‡
            questionInput.value = '';
            if (uploadedImageBase64) {
                uploadedImageBase64 = null;
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                imageUpload.value = '';
                imageName.textContent = '';
            }

            // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            const typingIndicator = addTypingIndicator();

            try {
                // è°ƒç”¨API
                const answer = formatAIResponse(await callArkApi(question,sort_token_pu,img_base64));
                // ç§»é™¤"æ­£åœ¨è¾“å…¥"çŠ¶æ€
                typingIndicator.remove();

                // æ·»åŠ AIå›ç­”åˆ°å¯¹è¯
                addMessageToChat(answer, 'ai');
            } catch (error) {
                // ç§»é™¤"æ­£åœ¨è¾“å…¥"çŠ¶æ€
                typingIndicator.remove();

                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                addMessageToChat(`è°ƒç”¨å¤±è´¥: ${error.message}`, 'ai', null, true);
            }
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
        function addMessageToChat(content, role, imageBase64 = null, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-appear';

            let imageHtml = '';
            if (imageBase64 && role === 'user') {
                imageHtml = `
                    <div class="mb-2">
                        <img src="${imageBase64}" alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡" class="max-h-40 max-w-full object-contain rounded">
                    </div>
                `;
            }

            const contentClass = isError ? 'text-red-600' : 'text-neutral-800';

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-3 justify-end">
                        <div class="bg-primary/10 rounded-lg rounded-tr-none px-4 py-3 shadow-sm max-w-[85%]">
                            ${imageHtml}
                            <p class="${contentClass}">${content}</p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-neutral-300 flex items-center justify-center text-neutral-700 flex-shrink-0">
                            <i class="fa fa-user"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
                            <i class="fa fa-robot"></i>
                        </div>
                        <div class="bg-white rounded-lg rounded-tl-none px-4 py-3 shadow-sm max-w-[85%]">
                            <p class="${contentClass}">${content}</p>
                        </div>
                    </div>
                `;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ·»åŠ "æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        function addTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'message-appear';
            indicatorDiv.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-white rounded-lg rounded-tl-none px-4 py-3 shadow-sm max-w-[85%]">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;

            chatContainer.appendChild(indicatorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return indicatorDiv;
        }
        // è°ƒç”¨åç«¯æ¥å£è·å–å›ç­”ï¼ˆå·²æ·»åŠ tokenè®¤è¯ï¼‰
        // æ–°å¢ retryCount å‚æ•°ï¼Œè®°å½•é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤0ï¼Œé¦–æ¬¡è°ƒç”¨ä¸è®¡æ•°ï¼‰
        async function callArkApi(question, access_token, imageBase64 = null, retryCount = 0) {
            // é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆæ¯”å¦‚æœ€å¤šé‡è¯•2æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰
            const MAX_RETRIES = 2;
            if (retryCount > MAX_RETRIES) {
                console.error(`å·²è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ${MAX_RETRIES}æ¬¡ï¼‰ï¼Œç»ˆæ­¢è°ƒç”¨`);
                alert("è°ƒç”¨é”™è¯¯");
                return "æˆ‘æ— æ³•è§£æè¿™å¼ å›¾ç‰‡å‘¢";
            }

            // 1. æ„å»ºè¯·æ±‚URLå’Œå‚æ•°
            const url = new URL("https://bean-bun-ai.zeabur.app/call_ark_api");
            url.searchParams.append("question", question);
            if (imageBase64) {
                url.searchParams.append("img_b64", imageBase64);
            }

            try {
                // 2. å‘é€è¯·æ±‚
                const response = await fetch(url.toString(), {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${access_token}`
                    },
                    body: JSON.stringify({}),
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${response.status}`);
                }

                // 3. å¤„ç†æˆåŠŸå“åº”
                const result = await response.text();
                return result
                    .replace(/^"|"$/g, '')
                    .replace(/\\n|[\n\r]/g, '<br>');

            } catch (error) {
                console.error(`ç¬¬${retryCount + 1}æ¬¡è°ƒç”¨å¤±è´¥ï¼š`, error);
                const statusCode = error.message.match(/çŠ¶æ€ç ï¼š(\d+)/)?.[1];

                // ä»…å¤„ç†401é”™è¯¯ï¼Œä¸”æœªè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
                if (statusCode === "401" && retryCount < MAX_RETRIES) {
                    console.log(`æ£€æµ‹åˆ°tokenè¿‡æœŸï¼Œå‡†å¤‡ç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);

                    const longToken = localStorage.getItem('long_token');
                    try {
                        // å°è¯•åˆ·æ–°token
                        const newAccessToken = await refreshAccessToken(longToken);
                        localStorage.setItem('access_token', newAccessToken);
                        sort_token_pu = newAccessToken;

                        // é‡è¯•æ—¶é‡è¯•æ¬¡æ•°+1
                        return await callArkApi(question, newAccessToken, imageBase64, retryCount + 1);

                    } catch (refreshError) {
                        console.error("tokenåˆ·æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...");
                        try {
                            // é‡æ–°åˆå§‹åŒ–
                            await getGraphicCookie();
                            const newAccessToken = localStorage.getItem('access_token');
                            sort_token_pu = newAccessToken;

                            // é‡è¯•æ—¶é‡è¯•æ¬¡æ•°+1
                            return await callArkApi(question, newAccessToken, imageBase64, retryCount + 1);

                        } catch (initError) {
                            console.error("é‡æ–°åˆå§‹åŒ–å¤±è´¥ï¼Œç»ˆæ­¢é‡è¯•");
                            window.location.reload(true);
                            return "æˆ‘æ— æ³•è§£æè¿™å¼ å›¾ç‰‡å‘¢";
                        }
                    }

                } else {
                    // é401é”™è¯¯ï¼Œæˆ–è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼šç›´æ¥è¿”å›æç¤º
                    console.log("æ¥å£æœ¬èº«é”™è¯¯æˆ–é‡è¯•æ¬¡æ•°è€—å°½ï¼Œç»ˆæ­¢è°ƒç”¨");
                    window.location.reload(true);
                    return "æˆ‘æ— æ³•è§£æè¿™å¼ å›¾ç‰‡å‘¢";
                }
            }
        }
        /**
         * ç”¨é•¿æœŸtokenåˆ·æ–°çŸ­æœŸaccess_token
         * @param {string} longToken - æœ¬åœ°å­˜å‚¨çš„é•¿æœŸtoken
         * @returns {Promise<string>} æ–°çš„access_token
         */
        async function refreshAccessToken(longToken) {
            if (!longToken) {
                throw new Error("é•¿æœŸtokenä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°");
            }

            try {
                // è°ƒç”¨åç«¯åˆ·æ–°æ¥å£
                const response = await fetch("https://bean-bun-ai.zeabur.app/token/refresh", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json", // å£°æ˜è¯·æ±‚ä½“ä¸ºJSONæ ¼å¼
                    },
                    // è¯·æ±‚ä½“ï¼šæŒ‰åç«¯RefreshRequestæ¨¡å‹è¦æ±‚ï¼Œä¼ é€’long_tokenå­—æ®µ
                    body: JSON.stringify({
                        long_token: longToken // å­—æ®µåä¸åç«¯BaseModelå®šä¹‰ä¸€è‡´
                    })
                });

                // å¤„ç†å“åº”çŠ¶æ€
                if (!response.ok) {
                    if (response.status === 401) {
                        // 401é€šå¸¸è¡¨ç¤ºé•¿æœŸtokenå·²è¿‡æœŸæˆ–æ— æ•ˆ
                        throw new Error("é•¿æœŸtokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°åˆå§‹åŒ–");
                    }
                    throw new Error(`åˆ·æ–°tokenå¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                }

                // è§£æè¿”å›ç»“æœ
                const result = await response.json();
                console.log("åˆ·æ–°tokenæˆåŠŸï¼Œæ–°çš„access_tokenï¼š", result.access_token);

                // è¿”å›æ–°çš„access_tokenï¼ˆåç»­å¯ä¿å­˜åˆ°localStorageï¼‰
                return result.access_token;

            } catch (error) {
                console.error("åˆ·æ–°tokenè¿‡ç¨‹å‡ºé”™ï¼š", error.message);
                throw error; // æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†ï¼ˆå¦‚é‡æ–°åˆå§‹åŒ–ï¼‰
            }
        }
        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        questionInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight > 120 ? 120 : this.scrollHeight) + 'px';
        });
        const { hasShortToken, hasLongToken, bothExist } = checkTokensInStorage();
        //1-æ£€æŸ¥localStorageä¸­æ˜¯å¦å­˜åœ¨é•¿æœŸtokenå’ŒçŸ­æœŸtoken
        if(bothExist){
            //ä¸¤ä¸ªtokenéƒ½å­˜åœ¨ï¼Œè·å–ä¸¤ä¸ªtokençš„å€¼
            sort_token_pu = localStorage.getItem('short_token');
            long_token_pu = localStorage.getItem('long_token');
            //è°ƒç”¨æ¥å£ä½¿ç”¨çŸ­æœŸtokenéªŒè¯è·å–æ•°æ®
        }
        else{
            //å¼€å¯å…¨å±åŠ è½½
            showLoading()
            //2-tokenä¸å­˜åœ¨ï¼Œè°ƒç”¨åˆå§‹åŒ–æ¥å£
            getGraphicCookie();
        }
        //æ¸²æŸ“ç”¨æˆ·å¯¹è¯è®°å½•
        /**
         * åˆ†é¡µè·å–å¹¶æ¸²æŸ“æ‰€æœ‰å¯¹è¯è®°å½•ï¼ˆåŒ…å«Tokenè¿‡æœŸå¤„ç†é€»è¾‘ï¼‰
         * @param {string} accessToken - åŠ å¯†çš„access_token
         */
        async function loadAndRenderAllConversations(accessToken) {
            let currentPage = 1; // ä»ç¬¬1é¡µå¼€å§‹
            const pageSize = 20; // æ¯é¡µ20æ¡
            let isLastPage = false;
            const MAX_RETRIES = 2; // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¸callArkApiä¿æŒä¸€è‡´

            // å¼€å§‹è·å–æ•°æ®æ—¶ï¼Œå¼€å¯å…¨å±åŠ è½½
            showLoading();

            try {
                while (!isLastPage) {
                    // è°ƒç”¨å¸¦é‡è¯•é€»è¾‘çš„å•é¡µæ•°æ®è·å–å‡½æ•°
                    const result = await fetchConversationPage(
                        currentPage,
                        pageSize,
                        accessToken,
                        0, // åˆå§‹é‡è¯•æ¬¡æ•°
                        MAX_RETRIES
                    );

                    // æå–å½“å‰é¡µæ•°æ®å’Œåˆ†é¡µä¿¡æ¯
                    const { data: records, pagination } = result.data;
                    const { has_next: hasNext } = pagination;

                    // éå†è®°å½•å¹¶æŒ‰è§’è‰²æ¸²æŸ“
                    records.forEach(record => {
                        const { role, content_text: content, img_url: imgUrl } = record;

                        if (role === 1) {
                            // ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¸¦å¯é€‰å›¾ç‰‡ï¼‰
                            imgUrl ?
                                addMessageToChat(content, 'user', imgUrl) :
                                addMessageToChat(content, 'user');
                        } else if (role === 2) {
                            // AIæ¶ˆæ¯
                            addMessageToChat(content, 'ai');
                        }
                    });

                    // æ›´æ–°åˆ†é¡µçŠ¶æ€
                    isLastPage = !hasNext;
                    currentPage++;
                    console.log(`å·²åŠ è½½ç¬¬${currentPage - 1}é¡µï¼Œå‰©ä½™æ•°æ®ï¼š${!isLastPage ? 'æœ‰' : 'æ— '}`);
                }

                console.log('å…¨éƒ¨å¯¹è¯è®°å½•åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯è®°å½•å¤±è´¥ï¼š', error);
                alert('åŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                // æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œæœ€ç»ˆéƒ½å…³é—­å…¨å±åŠ è½½
                hideLoading();
            }
        }

        /**
         * è·å–å•é¡µå¯¹è¯è®°å½•ï¼ˆåŒ…å«Tokené‡è¯•é€»è¾‘ï¼‰
         * @param {number} page - é¡µç 
         * @param {number} pageSize - æ¯é¡µæ¡æ•°
         * @param {string} accessToken - è®¿é—®ä»¤ç‰Œ
         * @param {number} retryCount - å½“å‰é‡è¯•æ¬¡æ•°
         * @param {number} maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•°
         * @returns {Promise} æ¥å£è¿”å›çš„JSONæ•°æ®
         */
        async function fetchConversationPage(page, pageSize, accessToken, retryCount, maxRetries) {
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åˆ™ç»ˆæ­¢
            if (retryCount > maxRetries) {
                console.error(`å·²è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ${maxRetries}æ¬¡ï¼‰ï¼Œç»ˆæ­¢è¯·æ±‚`);
                throw new Error(`è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ${maxRetries}æ¬¡ï¼‰`);
            }

            // æ„å»ºè¯·æ±‚URL
            const url = new URL('https://bean-bun-ai.zeabur.app/get_conversation_transcript', window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('page_size', pageSize);

            try {
                // å‘é€å¸¦Tokençš„GETè¯·æ±‚
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}` // é€šè¿‡è¯·æ±‚å¤´ä¼ é€’Token
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç ï¼š${response.status}`);
                }

                // è¿”å›æˆåŠŸå“åº”
                return await response.json();

            } catch (error) {
                console.error(`ç¬¬${retryCount + 1}æ¬¡è¯·æ±‚å¤±è´¥ï¼š`, error);
                const statusCode = error.message.match(/çŠ¶æ€ç ï¼š(\d+)/)?.[1];

                // å¤„ç†401 Tokenè¿‡æœŸé”™è¯¯
                if (statusCode === '401' && retryCount < maxRetries) {
                    console.log(`Tokenè¿‡æœŸï¼Œå‡†å¤‡ç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);

                    const longToken = localStorage.getItem('long_token');
                    try {
                        // å°è¯•åˆ·æ–°Token
                        const newAccessToken = await refreshAccessToken(longToken);
                        localStorage.setItem('access_token', newAccessToken);

                        // ç”¨æ–°Tokené‡è¯•
                        return await fetchConversationPage(
                            page,
                            pageSize,
                            newAccessToken,
                            retryCount + 1,
                            maxRetries
                        );

                    } catch (refreshError) {
                        console.error('Tokenåˆ·æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
                        try {
                            // é‡æ–°åˆå§‹åŒ–Token
                            await getGraphicCookie();
                            const newAccessToken = localStorage.getItem('access_token');

                            // ç”¨æ–°åˆå§‹åŒ–çš„Tokené‡è¯•
                            return await fetchConversationPage(
                                page,
                                pageSize,
                                newAccessToken,
                                retryCount + 1,
                                maxRetries
                            );

                        } catch (initError) {
                            console.error('é‡æ–°åˆå§‹åŒ–Tokenå¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹');
                            window.location.reload(true); // åˆ·æ–°é¡µé¢é‡æ–°è·å–Token
                            throw new Error('TokenéªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                        }
                    }

                } else {
                    // é401é”™è¯¯æˆ–é‡è¯•æ¬¡æ•°è€—å°½
                    console.log('éTokené”™è¯¯æˆ–é‡è¯•æ¬¡æ•°è€—å°½ï¼Œç»ˆæ­¢è¯·æ±‚');
                    throw error;
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ä»æœ¬åœ°å­˜å‚¨è·å–short_tokençŸ­æœŸtoken
            const accessToken = localStorage.getItem('short_token');
            if (accessToken) {
                // å·²æœ‰Tokenï¼Œç›´æ¥åŠ è½½è®°å½•
                loadAndRenderAllConversations(accessToken);
            } else {
                // æ— Tokenï¼Œå…ˆåˆå§‹åŒ–Token
                console.log('æœªæ‰¾åˆ°access_tokenï¼Œå°è¯•åˆå§‹åŒ–...');
                // åˆå§‹åŒ–Tokenè¿‡ç¨‹ä¹Ÿéœ€è¦åŠ è½½çŠ¶æ€
                showLoading();
                getGraphicCookie()
                    .then(() => {
                        const newAccessToken = localStorage.getItem('short_token');
                        if (newAccessToken) {
                            loadAndRenderAllConversations(newAccessToken);
                        } else {
                            alert('è·å–è®¿é—®æƒé™å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                            hideLoading(); // åˆå§‹åŒ–å¤±è´¥æ—¶å…³é—­åŠ è½½
                        }
                    })
                    .catch(error => {
                        console.error('åˆå§‹åŒ–Tokenå¤±è´¥ï¼š', error);
                        alert('è·å–è®¿é—®æƒé™å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                        hideLoading(); // åˆå§‹åŒ–å¤±è´¥æ—¶å…³é—­åŠ è½½
                    });
            }
        });
    </script>
</body>
</html>